<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-color: #47c8ff;
      --text-color: #333;
      --text-color-light: #666;
      --title-color: #FC2E2E;
      --accent-yellow: #ffc107;
      --accent-green: #4caf50;
      --accent-red: #e61414;
      --accent-red-alt: #e74c3c;
      --accent-orange: #ff8800;
      --accent-blue: #4361ee;
      --accent-blue-hover: #3f37c9;
      --accent-cyan: #00E3E1;
      --input-bg: #fff;
      --input-text: #333;
      --input-border: #ccc;
      --packet-bg: #fff;
      --packet-border: #ccc;
      --no-results-bg: #f8f8f8;
      --highlight-bg: yellow;
      --highlight-text: #333;
      --modal-bg: #fff;
      --overlay-bg: rgba(0, 0, 0, 0.7);
      --shadow-color: rgba(0, 0, 0, 0.2);
      --toggle-bg: #e0e0e0;
      --toggle-active-bg: var(--accent-blue);
      --toggle-active-text: #fff;
      --itinerary-border: #e0e0e0;
      --ai-box-bg: #fff;
      --ai-box-shadow: rgba(0,0,0,0.15);
    }

    body.dark-mode {
      --bg-color: #1a1c20;
      --text-color: #e0e0e0;
      --text-color-light: #aaa;
      --title-color: #ff5c5c;
      --accent-yellow: #ffc107;
      --accent-green: #388e3c;
      --accent-red: #d32f2f;
      --accent-red-alt: #c0392b;
      --accent-orange: #f57c00;
      --accent-blue: #536dfe;
      --accent-blue-hover: #3d5afe;
      --accent-cyan: #00bcd4;
      --input-bg: #2c2f36;
      --input-text: #e0e0e0;
      --input-border: #555;
      --packet-bg: #22252a;
      --packet-border: #444;
      --no-results-bg: #22252a;
      --highlight-bg: #b8860b;
      --highlight-text: #fff;
      --modal-bg: #2c2f36;
      --overlay-bg: rgba(0, 0, 0, 0.8);
      --shadow-color: rgba(0, 0, 0, 0.4);
      --toggle-bg: #333;
      --toggle-active-bg: var(--accent-blue);
      --toggle-active-text: #fff;
      --itinerary-border: #444;
      --ai-box-bg: #2c2f36;
      --ai-box-shadow: rgba(0,0,0,0.3);
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    #theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid var(--input-border);
      background-color: var(--input-bg);
      color: var(--text-color);
      font-size: 20px;
      cursor: pointer;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    #Search {
      background-color: var(--accent-yellow);
      color: #000;
    }

    #title {
      text-align: center;
      font-size: 36px;
      font-weight: bold;
      color: var(--title-color);
      width: 100%;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input,
    button,
    select,
    textarea {
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      width: 300px;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    input[type="datetime-local"] {
        width: 300px;
    }

    input,
    select,
    textarea {
      background-color: var(--input-bg);
      color: var(--input-text);
    }

    .dynamic-input-group {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 10px;
    }

    .dynamic-input {
      margin-bottom: 0 !important;
    }

    .dynamic-input-group button {
      width: 30px !important;
      padding: 8px 0;
    }

    button {
      background-color: var(--accent-green);
      color: white;
      cursor: pointer;
      width: 100px;
    }

    #results {
      margin-top: 20px;
      width: 100%;
    }

    .packet {
      border: 1px solid var(--packet-border);
      padding: 10px;
      margin-bottom: 10px;
      background-color: var(--packet-bg);
    }

    .packet p {
      margin: 5px 0;
      word-wrap: break-word;
    }
    
    .packet .entry-type-header {
      font-weight: bold;
      font-size: 1.1em;
      color: var(--accent-blue);
      margin-bottom: 10px;
    }


    .packet button {
      margin-top: 5px;
      margin-right: 5px;
    }

    #Clear {
      background-color: var(--accent-red);
    }

    #Save {
      background-color: var(--accent-orange);
    }
    
    #undoBtn {
      background-color: var(--accent-cyan);
      color: #000;
    }

    #undoBtn:disabled {
      background-color: var(--toggle-bg);
      color: var(--text-color-light);
      cursor: not-allowed;
      opacity: 0.7;
    }


    .highlight {
      background-color: var(--highlight-bg);
      color: var(--highlight-text);
      font-weight: bold;
    }

    .no-results {
      padding: 15px;
      text-align: center;
      font-style: italic;
      background-color: var(--no-results-bg);
    }
    
    #mode-toggle {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }

    .toggle-btn {
        padding: 10px 20px;
        border: 1px solid var(--input-border);
        background-color: var(--toggle-bg);
        color: var(--text-color);
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
        width: 120px;
    }

    .toggle-btn:first-child {
        border-top-left-radius: 5px;
        border-bottom-left-radius: 5px;
    }

    .toggle-btn:last-child {
        border-top-right-radius: 5px;
        border-bottom-right-radius: 5px;
        border-left: none;
    }
    
    .toggle-btn:not(:first-child):not(:last-child) {
        border-radius: 0;
        border-left: none;
    }

    .toggle-btn.active {
        background-color: var(--toggle-active-bg);
        color: var(--toggle-active-text);
        font-weight: bold;
    }

    .flight-segment {
        border: 1px solid var(--input-border);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: var(--input-bg);
    }
    .flight-segment h4 {
        margin-top: 0;
        border-bottom: 1px solid var(--input-border);
        padding-bottom: 5px;
        margin-bottom: 10px;
    }
    .segment-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .segment-row input {
        flex: 1;
        min-width: 200px;
        width: auto;
    }

    .itinerary-display {
      border: 1px solid var(--itinerary-border);
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
    }
    .itinerary-summary {
        font-size: 0.9em;
        color: var(--text-color-light);
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px dashed var(--itinerary-border);
    }
    .itinerary-segment, .itinerary-layover {
        margin-bottom: 8px;
    }
    .itinerary-segment span {
        font-weight: bold;
    }
    .itinerary-layover {
        color: var(--accent-orange);
        font-style: italic;
        padding-left: 20px;
    }

    .fare-details {
      display: flex;
      gap: 10px;
    }
    .fare-details input {
      width: 145px;
    }

    .login-overlay {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--overlay-bg);
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .login-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .login-modal {
      background-color: var(--modal-bg);
      padding: 2.5rem;
      border-radius: 8px;
      box-shadow: 0 10px 25px var(--shadow-color);
      width: 90%;
      max-width: 400px;
      text-align: center;
      transform: scale(0.95);
      transition: transform 0.3s ease, background-color 0.3s;
    }

    .login-overlay.visible .login-modal {
      transform: scale(1);
    }

    .login-modal h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }

    .login-modal p {
      margin-bottom: 1.5rem;
      color: var(--text-color-light);
    }

    .input-group {
      margin-bottom: 1rem;
      text-align: left;
    }

    .input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--input-border);
      border-radius: 4px;
    }

    #loginButton {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: var(--accent-blue);
      color: white;
      transition: background-color 0.2s;
    }

    #loginButton:hover {
      background-color: var(--accent-blue-hover);
    }

    .login-error {
      color: var(--accent-red);
      margin-top: 1rem;
      height: 1.2rem;
      font-size: 0.9rem;
    }

    /* AI STYLES */
    .ai-controls {
      padding: 15px;
      margin: 10px 0;
      border: 1px dashed var(--input-border);
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      width: 300px;
    }
    .ai-controls button {
      width: 100%;
    }
    .ai-controls input[type="file"] {
      width: 100%;
    }

    #ai-assistant-box {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 350px;
      max-height: 500px;
      background-color: var(--ai-box-bg);
      border-radius: 12px;
      box-shadow: 0 6px 20px var(--ai-box-shadow);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    #ai-assistant-box.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    #ai-assistant-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid var(--input-border);
    }

    #ai-assistant-header h4 {
      margin: 0;
      font-size: 1rem;
    }

    #ai-assistant-close {
      position: static;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color-light);
      padding: 0;
    }

    #ai-chat-history {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 100px;
    }

    .chat-message {
        padding: 8px 12px;
        border-radius: 18px;
        max-width: 80%;
        word-wrap: break-word;
        font-size: 0.9rem;
    }

    .chat-message.user {
        background-color: var(--accent-blue);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }
    
    .chat-message.ai {
        background-color: var(--toggle-bg);
        color: var(--text-color);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }

    .chat-message.error {
        background-color: var(--accent-red-alt);
        color: white;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }

    .chat-message.info {
        font-style: italic;
        align-self: center;
        max-width: 100%;
        text-align: center;
        background-color: transparent;
        color: var(--text-color-light);
        padding: 2px;
    }

    #ai-input-container {
        display: flex;
        align-items: center;
        padding: 10px;
        border-top: 1px solid var(--input-border);
        gap: 5px;
    }

    #ai-user-input {
        flex-grow: 1;
        border: 1px solid var(--input-border);
        border-radius: 20px;
        padding: 8px 15px;
        resize: none;
        background-color: var(--input-bg);
        color: var(--input-text);
        font-family: inherit;
        font-size: 0.9rem;
        margin: 0;
    }

    #ai-record-btn, #ai-send-btn {
        border: none;
        background-color: transparent;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--accent-blue);
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    #ai-record-btn:hover, #ai-send-btn:hover {
        background-color: var(--toggle-bg);
    }

    #ai-record-btn.recording {
        color: var(--accent-red);
        animation: pulse 1.5s infinite;
    }
    
    #loadingStatus {
      text-align: center;
      padding: 10px;
      color: var(--text-color-light);
      font-style: italic;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(230, 20, 20, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(230, 20, 20, 0); }
        100% { box-shadow: 0 0 0 0 rgba(230, 20, 20, 0); }
    }

    /* Custom Modal Styles */
    .modal-overlay {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: var(--overlay-bg);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: var(--modal-bg);
      margin: auto;
      padding: 20px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 15px var(--shadow-color);
      text-align: center;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }

    .modal-content h3 {
      margin-top: 0;
      color: var(--text-color);
    }

    .modal-content p {
      color: var(--text-color-light);
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      width: auto;
      min-width: 100px;
    }

    .modal-btn.confirm {
      background-color: var(--accent-blue);
      color: white;
    }
    .modal-btn.confirm:hover {
      background-color: var(--accent-blue-hover);
    }
    .modal-btn.cancel {
      background-color: var(--toggle-bg);
      color: var(--text-color);
    }
    .modal-btn.ok {
      background-color: var(--accent-blue);
      color: white;
    }

  </style>
  <title>By Success</title>
  <script type="module">
    import { GoogleGenAI, Type } from "https://esm.run/@google/genai";
    window.GoogleGenAI = GoogleGenAI;
    window.GenaiType = Type;
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>

<body>
  <button id="theme-toggle" title="Toggle dark/light mode">ðŸŒ™</button>
  <div id="title">Four Direction Travels And Tours</div>
  <div class="expenses">
    <button onclick="window.location.href='expenses.html';"
      style="background-color: var(--accent-cyan); color: #000000;">In/Ex</button>
  </div>
  <div id="searchArea">
    <label for="searchInput">Search:</label>
    <input type="text" id="searchInput">
    <label for="dateLimit">Date Limit:</label>
    <input type="date" id="dateLimit">
    <div>
      <button id="Search" onclick="handleSearchClick()">Search</button>
      <button id="Clear" onclick="clearSearch(); showEntrySection()">Clear Search</button>
      <button id="undoBtn" onclick="undoLastAction()" disabled>Undo</button>
    </div>
  </div>
  
  <div id="mode-toggle">
    <button id="courier-mode-btn" class="toggle-btn active" onclick="setMode('courier')">Courier</button>
    <button id="ticketing-mode-btn" class="toggle-btn" onclick="setMode('ticketing')">Ticketing</button>
    <button id="manifest-mode-btn" class="toggle-btn" onclick="setMode('manifest')">Manifest</button>
  </div>

  <div id="entrySection">
    <!-- AI Controls -->
    <div class="ai-controls">
      <label for="imageUpload">Autofill with AI</label>
      <input type="file" id="imageUpload" accept="image/*,application/pdf">
      <button id="autofillBtn" onclick="handleAutofill()">Analyze Image</button>
    </div>

    <div>
      <!-- Common Fields -->
      <label>Date:</label>
      <input type="date" id="date">
      <label id="recNoLabel" for="recNo">Rec NO:</label>
      <input type="number" id="recNo">
      <label>Email:</label>
      <input type="text" id="email">
      <label>Price:</label>
      <input type="number" id="price">

      <!-- Courier Specific Fields -->
      <div id="courierForm">
        <label>Sender Name:</label>
        <input type="text" id="senderName">
        <label>Sender Address:</label>
        <input type="text" id="senderAddress">
        <label>Sender Contact Number:</label>
        <input type="number" id="senderContact">
        <label>Weight KG:</label>
        <input type="text" id="weightTicket">
        <label>Receiver Name:</label>
        <input type="text" id="receiverName">
        <label>Receiver Address:</label>
        <input type="text" id="receiverAddress">
        <label>Receiver Contact Number:</label>
        <input type="number" id="receiverContact">
        <label>Gateway:</label>
        <input type="text" id="update">
        <label>Bill Item</label>
        <input type="text" id="billItem">
        <label>Tracking Number:</label>
        <div id="trackingInputs">
          <div class="dynamic-input-group">
            <input type="text" id="trackingNumber" class="dynamic-input">
            <button type="button" onclick="addTrackingInput()"
              style="width: 30px; background-color: var(--accent-green);">+</button>
          </div>
        </div>
        <label>Delivered Date:</label>
        <input type="date" id="deliveredDate">
        <label>Item:</label>
        <div id="aboutCourierTicket">
          <textarea id="courierTicket" rows="5" cols="40"></textarea>
        </div>
      </div>

      <!-- Ticketing Specific Fields -->
      <div id="ticketingForm" style="display: none;">
        <label>Passenger Name:</label>
        <input type="text" id="passengerName">
        <label>Passenger Contact:</label>
        <input type="number" id="passengerContact">
        <label>PNR / Booking Reference:</label>
        <input type="text" id="pnrNumber">
        <label>Ticket Number:</label>
        <input type="text" id="ticketNumber">
        <label>Trip Type:</label>
        <select id="tripType">
            <option value="ONE_WAY">One Way</option>
            <option value="ROUND_TRIP">Round Trip</option>
        </select>
        <label>Fare Details:</label>
        <div class="fare-details">
            <input type="number" id="baseFare" placeholder="Base Fare">
            <input type="number" id="taxes" placeholder="Taxes">
        </div>

        <label>Flight Segments:</label>
        <div id="flightSegmentsContainer">
            <!-- Flight segments will be added here dynamically -->
        </div>
        <button type="button" onclick="addFlightSegment()" style="width: 300px;">+ Add Flight Segment</button>

        <label>Luggage Weight:</label>
        <input type="text" id="luggageWeight">
        <label>Remarks:</label>
        <textarea id="remarks" rows="5" cols="40"></textarea>
      </div>

      <!-- Manifest Specific Fields -->
      <div id="manifestForm" style="display: none;">
        <label>Pack:</label>
        <input type="text" id="pack">
        <label>Receiver Name:</label>
        <input type="text" id="manifestReceiverName">
        <label>Receiver Country:</label>
        <input type="text" id="receiverCountry">
        <label>Gateway:</label>
        <input type="text" id="manifestGateway">
      </div>
      
      <div id="updateButton">
        <button id="Save" onclick="saveData()">Save</button>
      </div>
    </div>
  </div>

  <div id="totalPrice"></div>
  <div id="totalPackages"></div>
  <div id="resultsTitle">Results:</div>
  <div id="results"></div>
  <div id="loadingStatus"></div>
  
  <div id="loginOverlay" class="login-overlay">
    <div class="login-modal">
      <h2>Admin Login</h2>
      <p>Four Direction Travels And Tours</p>
      <div class="input-group">
        <label for="adminEmail">Email</label>
        <input type="email" id="adminEmail" value="fourdirection02@gmail.com" disabled>
      </div>
      <div class="input-group">
        <label for="adminPassword">Password</label>
        <input type="password" id="adminPassword" placeholder="Enter your password" autofocus>
      </div>
      <button id="loginButton">Login</button>
      <p id="loginError" class="login-error"></p>
    </div>
  </div>

  <div id="ai-assistant-box">
    <div id="ai-assistant-header">
        <h4>AI Assistant</h4>
        <button id="ai-assistant-close" onclick="hideAiMessage()">Ã—</button>
    </div>
    <div id="ai-chat-history">
        <!-- Messages will be appended here -->
    </div>
    <div id="ai-input-container">
        <textarea id="ai-user-input" placeholder="Type or use voice to correct..." rows="2"></textarea>
        <button id="ai-record-btn" title="Record voice command">ðŸŽ¤</button>
        <button id="ai-send-btn" title="Send message">âž¤</button>
    </div>
  </div>

  <div id="customModalOverlay" class="modal-overlay">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <p id="modalMessage"></p>
      <div class="modal-actions">
        <button id="modalConfirmBtn" class="modal-btn confirm">Confirm</button>
        <button id="modalCancelBtn" class="modal-btn cancel">Cancel</button>
        <button id="modalOkBtn" class="modal-btn ok">OK</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC3pnVKpMYszW9XCEXkeOqIkAQUHXYdMRI",
      authDomain: "d-data-storage-399801.firebaseapp.com",
      databaseURL: "https://d-data-storage-399801-default-rtdb.firebaseio.com",
      projectId: "d-data-storage-399801",
      storageBucket: "d-data-storage-399801.appspot.com",
      messagingSenderId: "515303559494",
      appId: "1:515303559494:web:f108f881e01ee3ddec9547",
      measurementId: "G-BECRQ4T8BP"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let allPackets = [];
    const processedKeys = new Set();
    let searchTerm = '';
    let currentMode = 'courier';
    let currentEditingPacket = null; // Stores the full packet object being edited
    let actionHistory = [];
    const MAX_HISTORY_SIZE = 10;

    window.geminiApiKey = null;
    let lastAnalyzedImagePart = null; // for AI follow-up
    let recognition; // for SpeechRecognition
    let isRecording = false; // for SpeechRecognition state

    function toTitleCase(str) {
      if (!str) return '';
      return str
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function setMode(mode) {
        currentMode = mode;
        localStorage.setItem('entryMode', mode);
        document.getElementById('courierForm').style.display = mode === 'courier' ? 'block' : 'none';
        document.getElementById('ticketingForm').style.display = mode === 'ticketing' ? 'block' : 'none';
        document.getElementById('manifestForm').style.display = mode === 'manifest' ? 'block' : 'none';
        
        document.getElementById('courier-mode-btn').classList.toggle('active', mode === 'courier');
        document.getElementById('ticketing-mode-btn').classList.toggle('active', mode === 'ticketing');
        document.getElementById('manifest-mode-btn').classList.toggle('active', mode === 'manifest');
        
        document.getElementById('recNoLabel').textContent = mode === 'manifest' ? 'Manifest No:' : 'Rec NO:';

        clearInputs(false);
        displayResults();
    }
    window.setMode = setMode;

    // Custom Modal Logic
    function showModal(title, message, type = 'alert', onConfirm = () => {}) {
      const overlay = document.getElementById('customModalOverlay');
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;

      const confirmBtn = document.getElementById('modalConfirmBtn');
      const cancelBtn = document.getElementById('modalCancelBtn');
      const okBtn = document.getElementById('modalOkBtn');

      confirmBtn.style.display = type === 'confirm' ? 'inline-block' : 'none';
      cancelBtn.style.display = type === 'confirm' ? 'inline-block' : 'none';
      okBtn.style.display = type === 'alert' ? 'inline-block' : 'none';

      overlay.style.display = 'flex';

      const closeModal = () => {
        overlay.style.display = 'none';
        confirmBtn.onclick = null;
        cancelBtn.onclick = null;
        okBtn.onclick = null;
      };

      confirmBtn.onclick = () => {
        onConfirm();
        closeModal();
      };
      cancelBtn.onclick = closeModal;
      okBtn.onclick = closeModal;
    }

    // --- UNDO FUNCTIONALITY ---
    function logAction(action) {
        actionHistory.unshift(action);
        if (actionHistory.length > MAX_HISTORY_SIZE) {
            actionHistory.pop();
        }
        updateUndoButtonState();
    }

    function updateUndoButtonState() {
        const undoBtn = document.getElementById('undoBtn');
        if (undoBtn) {
            undoBtn.disabled = actionHistory.length === 0;
        }
    }

    async function undoLastAction() {
        if (actionHistory.length === 0) return;

        const lastAction = actionHistory.shift();
        updateUndoButtonState();

        try {
            switch (lastAction.type) {
                case 'add':
                    await database.ref(lastAction.addedData.path).remove();
                    allPackets = allPackets.filter(p => p.key !== lastAction.addedData.key);
                    break;
                case 'edit':
                    await database.ref(lastAction.oldData.path).set(lastAction.oldData);
                    const index = allPackets.findIndex(p => p.key === lastAction.oldData.key);
                    if (index > -1) {
                        allPackets[index] = lastAction.oldData;
                    } else { // Handle cases where path might have changed
                        allPackets = allPackets.filter(p => p.key !== lastAction.oldData.key);
                        allPackets.unshift(lastAction.oldData);
                    }
                    break;
                case 'delete':
                    await database.ref(lastAction.deletedData.path).set(lastAction.deletedData);
                    allPackets.unshift(lastAction.deletedData);
                    break;
            }
            displayResults();
            showModal('Success', `Undo successful: '${lastAction.type}' operation reversed.`);
        } catch (error) {
            console.error("Undo failed:", error);
            showModal('Error', 'Could not perform undo operation.');
            // Re-add the action to the history if the operation failed
            actionHistory.unshift(lastAction);
            updateUndoButtonState();
        }
    }
    window.undoLastAction = undoLastAction;

    async function performSave(packetData, oldDataForLog) {
        const [year, month] = packetData.date.split('-');
        const saveRoot = packetData.entryType === 'courier' ? 'courier_packets'
                     : packetData.entryType === 'ticketing' ? 'ticketing_packets'
                     : 'manifest_packets';
        const savePath = `${saveRoot}/${year}/${month}`;
        
        if (currentEditingPacket) {
            const oldPath = currentEditingPacket.path;
            const newPath = `${savePath}/${currentEditingPacket.key}`;
            const updatedPacket = { ...packetData, key: currentEditingPacket.key, path: newPath };

            logAction({ type: 'edit', oldData: oldDataForLog, newData: updatedPacket });
            
            if (oldPath !== newPath) {
                const updates = {};
                updates[oldPath] = null;
                updates[newPath] = packetData;
                await database.ref().update(updates);
                allPackets = allPackets.filter(p => p.key !== currentEditingPacket.key);
                allPackets.unshift(updatedPacket);
            } else {
                await database.ref(oldPath).update(packetData);
                const index = allPackets.findIndex(p => p.key === currentEditingPacket.key);
                if (index > -1) {
                    allPackets[index] = updatedPacket;
                }
            }
        } else {
            const newRecordRef = await database.ref(savePath).push(packetData);
            const newPacket = { ...packetData, key: newRecordRef.key, path: `${savePath}/${newRecordRef.key}`};
            allPackets.unshift(newPacket);
            logAction({ type: 'add', addedData: newPacket });
        }

        currentEditingPacket = null;
        clearInputs(true);
        displayResults();
    }

    async function saveData() {
        const requiredInputs = currentMode === 'courier' 
            ? ['recNo', 'senderName', 'senderContact', 'senderAddress', 'price']
            : currentMode === 'ticketing'
            ? ['recNo', 'passengerName', 'passengerContact', 'price']
            : ['recNo', 'manifestReceiverName', 'receiverCountry', 'price'];

        if (requiredInputs.some(id => !document.getElementById(id)?.value.trim())) {
            showModal('Input Required', `Please fill in all required input fields for ${currentMode}.`);
            return;
        }
      
        const dateValue = document.getElementById('date').value;
        if (!dateValue) {
            showModal('Input Required', 'Please select a date.');
            return;
        }
      
        const [year, month] = dateValue.split('-');
      
        let packetData = {
            entryType: currentMode,
            recNo: document.getElementById('recNo').value,
            date: dateValue,
            email: document.getElementById('email').value,
            price: document.getElementById('price').value,
        };

        if (currentMode === 'courier') {
            Object.assign(packetData, {
                senderName: toTitleCase(document.getElementById('senderName').value),
                senderAddress: toTitleCase(document.getElementById('senderAddress').value),
                senderContact: document.getElementById('senderContact').value,
                weightTicket: document.getElementById('weightTicket').value,
                receiverName: toTitleCase(document.getElementById('receiverName').value),
                receiverAddress: toTitleCase(document.getElementById('receiverAddress').value),
                receiverContact: document.getElementById('receiverContact').value,
                update: toTitleCase(document.getElementById('update').value),
                billItem: toTitleCase(document.getElementById('billItem').value),
                trackingNumber: getDynamicInputs('trackingInputs').join(','),
                deliveredDate: document.getElementById('deliveredDate').value,
                courierTicket: toTitleCase(document.getElementById('courierTicket').value)
            });
        } else if (currentMode === 'ticketing') {
            Object.assign(packetData, {
                passengerName: document.getElementById('passengerName').value,
                passengerContact: document.getElementById('passengerContact').value,
                pnrNumber: document.getElementById('pnrNumber').value,
                ticketNumber: document.getElementById('ticketNumber').value,
                tripType: document.getElementById('tripType').value,
                fareDetails: { base: document.getElementById('baseFare').value, taxes: document.getElementById('taxes').value },
                flightSegments: getFlightSegments(),
                luggageWeight: document.getElementById('luggageWeight').value,
                remarks: document.getElementById('remarks').value
            });
        } else if (currentMode === 'manifest') {
             Object.assign(packetData, {
                pack: document.getElementById('pack').value,
                receiverName: toTitleCase(document.getElementById('manifestReceiverName').value),
                receiverCountry: toTitleCase(document.getElementById('receiverCountry').value),
                update: toTitleCase(document.getElementById('manifestGateway').value) // re-using 'update' for gateway
            });
        }
        
        const conflictingPacket = allPackets.find(p =>
            p.entryType === packetData.entryType &&
            p.recNo === packetData.recNo && 
            p.date.startsWith(`${year}-${month}`) &&
            (!currentEditingPacket || p.key !== currentEditingPacket.key)
        );

        if (conflictingPacket) {
            showModal(
                'Confirm Overwrite', 
                `${currentMode === 'manifest' ? 'Manifest No' : 'RecNo'} ${packetData.recNo} already exists for this month. Do you want to overwrite it?`,
                'confirm',
                () => {
                    if (currentEditingPacket && currentEditingPacket.key !== conflictingPacket.key) {
                        const originalPacketToDelete = {...currentEditingPacket};
                        database.ref(originalPacketToDelete.path).remove();
                        allPackets = allPackets.filter(p => p.key !== originalPacketToDelete.key);
                        logAction({ type: 'delete', deletedData: originalPacketToDelete, reason: `overwrite of RecNo ${conflictingPacket.recNo}` });
                    }
                    
                    const oldDataToLog = {...conflictingPacket};
                    currentEditingPacket = conflictingPacket;
                    performSave(packetData, oldDataToLog);
                }
            );
        } else {
            const oldDataToLog = currentEditingPacket ? {...currentEditingPacket} : null;
            performSave(packetData, oldDataToLog);
        }
    }
    window.saveData = saveData;

    function searchData() {
        searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        displayResults();
    }
    
    function flattenObjectValues(obj) {
        let values = '';
        for (const key in obj) {
            if (typeof obj[key] === 'object' && obj[key] !== null) {
                values += flattenObjectValues(obj[key]) + ' ';
            } else if (obj[key] !== null && typeof obj[key] !== 'undefined') {
                values += obj[key].toString().toLowerCase() + ' ';
            }
        }
        return values;
    }

    function displayResults() {
      let results = allPackets.filter(p => (p.entryType || 'courier') === currentMode);
      
      const dateLimit = document.getElementById('dateLimit').value;
      if (dateLimit) {
        results = results.filter(packet => packet.date === dateLimit);
      }
      
      if (searchTerm) {
          results = results.filter(packet => {
              const flatPacket = flattenObjectValues(packet);
              return flatPacket.includes(searchTerm);
          });
      }
      
      results.sort((a, b) => new Date(b.date) - new Date(a.date) || b.recNo - a.recNo);

      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = '';
      
      if (results.length === 0) {
        const noResultsDiv = document.createElement('div');
        noResultsDiv.className = 'no-results';
        noResultsDiv.textContent = searchTerm || dateLimit ? `No results found` : `No ${currentMode} records found.`;
        resultsContainer.appendChild(noResultsDiv);
        calculateAndDisplayTotal([]);
        calculateAndDisplayTotalPackages([]);
        return;
      }

      results.forEach((packet) => {
        const packetDiv = document.createElement('div');
        packetDiv.className = 'packet';
        
        if (packet.entryType === 'ticketing') {
            const itineraryHTML = renderItinerary(packet);
            const fareText = packet.fareDetails ? `Base: ${packet.fareDetails.base}, Tax: ${packet.fareDetails.taxes}` : 'N/A';
            packetDiv.innerHTML = `
                <p class="entry-type-header">TICKET</p>
                <p>Rec NO: ${highlightText(packet.recNo)}</p>
                <p>Date: ${highlightText(packet.date)}</p>
                <p>Price: ${highlightText(packet.price)}</p>
                <p>Passenger Name: ${highlightText(packet.passengerName)}</p>
                <p>PNR: ${highlightText(packet.pnrNumber)} | Ticket: ${highlightText(packet.ticketNumber)}</p>
                <p>Trip: ${highlightText(packet.tripType)} | Fare: ${highlightText(fareText)}</p>
                ${itineraryHTML}
                <p>Luggage: ${highlightText(packet.luggageWeight)}</p>
                <p>Remarks: ${highlightText(packet.remarks)}</p>
            `;
        } else if (packet.entryType === 'manifest') {
            packetDiv.innerHTML = `
                <p class="entry-type-header">MANIFEST</p>
                <p>Manifest No: ${highlightText(packet.recNo)}</p>
                <p>Date: ${highlightText(packet.date)}</p>
                <p>Email: ${highlightText(packet.email)}</p>
                <p>Price: ${highlightText(packet.price)}</p>
                <p>Pack: ${highlightText(packet.pack)}</p>
                <p>Receiver Name: ${highlightText(packet.receiverName)}</p>
                <p>Receiver Country: ${highlightText(packet.receiverCountry)}</p>
                <p>Gateway: ${highlightText(packet.update)}</p>
            `;
        } else { // Courier or old data
            const trackingNumbers = (packet.trackingNumber || '').split(',').filter(tn => tn.trim());
            const trackingLinks = trackingNumbers.map(tn => {
            const tn_trim = tn.trim();
            return tn_trim.startsWith('SG')
                ? `<a href="https://shipglobal.au/tracking?waybill=${tn_trim}&submit=Track" target="_blank">${highlightText(tn_trim)}</a>`
                : tn_trim.startsWith('FFC')
                ? `<a href="https://www.firstflightcanada.com/tracking?waybill=${tn_trim}&submit=Track" target="_blank">${highlightText(tn_trim)}</a>`
                : `<a href="https://parcelsapp.com/en/tracking/${tn_trim}" target="_blank">${highlightText(tn_trim)}</a>`;
            }).join(', ');
            packetDiv.innerHTML = `
                <p class="entry-type-header">COURIER</p>
                <p>Rec NO: ${highlightText(packet.recNo)}</p>
                <p>Date: ${highlightText(packet.date)}</p>
                <p>Email: ${highlightText(packet.email)}</p>
                <p>Sender Name: ${highlightText(packet.senderName)}</p>
                <p>Sender Address: ${highlightText(packet.senderAddress)}</p>
                <p>Sender Contact: ${highlightText(packet.senderContact)}</p>
                <p>Weight KG: ${highlightText(packet.weightTicket)}</p>
                <p>Price: ${highlightText(packet.price)}</p>
                <p>Receiver Name: ${highlightText(packet.receiverName)}</p>
                <p>Receiver Address: ${highlightText(packet.receiverAddress)}</p>
                <p>Receiver Contact: ${highlightText(packet.receiverContact)}</p>
                <p>Gateway: ${highlightText(packet.update)}</p>
                <p>Bill Item: ${highlightText(packet.billItem)}</p>
                <p>Tracking Number(s): ${trackingLinks}</p>
                <p>Delivered Date: ${highlightText(packet.deliveredDate)}</p>
                <p>Item: ${highlightText(packet.courierTicket)}</p>
            `;
        }

        const actionsContainer = document.createElement('div');
        actionsContainer.innerHTML = `
          <button onclick="editPacket('${packet.key}')">Edit</button>
          <button onclick="deletePacket('${packet.key}')" style="background-color: var(--accent-red-alt);">Delete</button>
          <button onclick="copyToClipboard('${packet.key}')">Copy</button>
          <button onclick="copyForPrint('${packet.key}')">Print</button>
          <button onclick="sendMail('${packet.key}')")">Mail</button>
          <button id="billBtn-${packet.key}" onclick="downloadBill('${packet.key}')">Bill</button>
        `;
        packetDiv.appendChild(actionsContainer);
        resultsContainer.appendChild(packetDiv);

        if (packet.entryType === 'ticketing' || packet.entryType === 'manifest') {
            document.getElementById(`billBtn-${packet.key}`).style.display = 'none';
        }
      });
      calculateAndDisplayTotal(results);
      calculateAndDisplayTotalPackages(results);
    }

    function highlightText(text) {
      if (!searchTerm || text === null || typeof text === 'undefined') return text || '';
      const textStr = text.toString();
      const searchStr = searchTerm.toLowerCase();
      const lowerText = textStr.toLowerCase();
      if (searchStr === '' || !lowerText.includes(searchStr)) return textStr;
      let result = '';
      let lastIndex = 0;
      let index;
      while ((index = lowerText.indexOf(searchStr, lastIndex)) !== -1) {
        result += textStr.substring(lastIndex, index);
        result += `<span class="highlight">${textStr.substring(index, index + searchStr.length)}</span>`;
        lastIndex = index + searchStr.length;
      }
      result += textStr.substring(lastIndex);
      return result;
    }
    window.highlightText = highlightText;
    
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      searchTerm = '';
      document.getElementById('dateLimit').value = '';
      displayResults();
    }
    window.clearSearch = clearSearch;

    function handleSearchClick() {
      searchData();
      hideEntrySection();
    }
    window.handleSearchClick = handleSearchClick;

    document.getElementById('searchInput').addEventListener('keyup', function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById('Search').click();
      }
    });

    function downloadBill(key) {
      const packet = allPackets.find(p => p.key === key);
      if (!packet || packet.entryType !== 'courier') return; 
      const canvas = document.createElement('canvas');
      canvas.width = 2417;
      canvas.height = 1157;
      const ctx = canvas.getContext('2d');
      const logo = new Image();
      logo.src = 'fourdirection.png';
      logo.onload = () => {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(logo, 0, 0, 2417, 1157);
        ctx.fillStyle = '#000000';
        ctx.font = ' 44px Arial';
        ctx.fillText(`${packet.recNo}`, 250, 397);
        ctx.fillText(`${packet.date}`, 1890, 394);
        ctx.fillText(`${packet.senderName}`, 570, 490);
        ctx.fillText(`${packet.senderContact}`, 1450, 490);
        ctx.fillText(`${packet.senderAddress}`, 320, 585);
        ctx.fillText(`${packet.receiverAddress}`, 1158, 586);
        ctx.fillText(`${packet.billItem}    ${packet.trackingNumber}`, 150, 865)
        ctx.font = 'bold 58px Arial';
        ctx.fillText(`${packet.price}.00`, 230, 995);
        const amountInWords = numberToWords(packet.price);
        ctx.font = '44px Arial';
        ctx.fillText(`${amountInWords} rupees only`, 530, 677);
        canvas.toBlob((blob) => {
          const link = document.createElement('a');
          link.download = `bill_${packet.recNo}.png`;
          link.href = URL.createObjectURL(blob);
          link.click();
          URL.revokeObjectURL(link.href);
        });
      };
    }
    window.downloadBill = downloadBill;
    
    function numberToWords(num) {
      const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
        'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen',
        'Seventeen', 'Eighteen', 'Nineteen'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
      num = parseFloat(num);
      if (isNaN(num)) return '';
      if (num === 0) return 'Zero';
      function convertLessThanOneThousand(n) {
        if (n === 0) return '';
        if (n < 20) return ones[n];
        if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? ' ' + ones[n % 10] : '');
        return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 !== 0 ? ' and ' + convertLessThanOneThousand(n % 100) : '');
      }
      let result = '';
      if (num >= 10000000) { result += convertLessThanOneThousand(Math.floor(num / 10000000)) + ' Crore '; num %= 10000000; }
      if (num >= 100000) { result += convertLessThanOneThousand(Math.floor(num / 100000)) + ' Lakh '; num %= 100000; }
      if (num >= 1000) { result += convertLessThanOneThousand(Math.floor(num / 1000)) + ' Thousand '; num %= 1000; }
      if (num > 0) { result += convertLessThanOneThousand(num); }
      return result.trim();
    }

    function copyToClipboard(key) {
      const packet = allPackets.find(p => p.key === key);
      if (!packet) return;
      let packetText = '';
      if (packet.entryType === 'ticketing') {
        packetText = `
    Entry Type: TICKET
    Rec NO: ${packet.recNo}
    Date: ${packet.date}
    Price: ${packet.price}
    Passenger Name: ${packet.passengerName}
    Passenger Contact: ${packet.passengerContact}
    PNR: ${packet.pnrNumber}
    Ticket Number: ${packet.ticketNumber}
    Trip Type: ${packet.tripType}
    Fare: Base ${packet.fareDetails?.base}, Taxes ${packet.fareDetails?.taxes}
    Luggage: ${packet.luggageWeight}
    Remarks: ${packet.remarks}
    --- Itinerary ---
    ${(packet.flightSegments || []).map(s => `    âœˆï¸ ${s.depAirport} -> ${s.arrAirport} on ${s.airline} ${s.flightNo}`).join('\n')}
        `;
      } else if (packet.entryType === 'manifest') {
        packetText = `
    Entry Type: MANIFEST
    Manifest No: ${packet.recNo}
    Date: ${packet.date}
    Email: ${packet.email}
    Price: ${packet.price}
    Pack: ${packet.pack}
    Receiver Name: ${packet.receiverName}
    Receiver Country: ${packet.receiverCountry}
    Gateway: ${packet.update}
        `;
      } else { // Courier
        packetText = `
    Entry Type: COURIER
    Rec NO: ${packet.recNo}
    Date: ${packet.date}
    Email: ${packet.email}
    Sender Name: ${packet.senderName}
    Sender Address: ${packet.senderAddress}
    Sender Contact: ${packet.senderContact}
    Weight KG: ${packet.weightTicket}
    Price: ${packet.price}
    Receiver Name: ${packet.receiverName}
    Receiver Address: ${packet.receiverAddress}
    Receiver Contact: ${packet.receiverContact}
    Gateway: ${packet.update}
    Bill Item: ${packet.billItem}
    Tracking Number: ${packet.trackingNumber}
    Delivered Date: ${packet.deliveredDate}
    Item: ${packet.courierTicket}
        `;
      }
      navigator.clipboard.writeText(packetText.trim()).then(() => showModal('Success', 'Copied to clipboard!'));
    }
    window.copyToClipboard = copyToClipboard;

    function copyForPrint(key) {
        const packet = allPackets.find(p => p.key === key);
        if (!packet) return;
        let packetText = '';
        if (packet.entryType === 'ticketing') {
            packetText = `
Four Direction Travels & Tours - 056-490449
Passenger: ${packet.passengerName}
PNR: ${packet.pnrNumber}
Date: ${packet.date}
${(packet.flightSegments || []).map(s => `Flight: ${s.airline} ${s.flightNo} from ${s.depAirport} to ${s.arrAirport}`).join('\n')}
            `;
        } else if (packet.entryType === 'manifest') {
            packetText = `
Four Direction - 056-490449
Manifest No: ${packet.recNo}
Date: ${packet.date}
Receiver: ${packet.receiverName} (${packet.receiverCountry})
Gateway: ${packet.update}
Pack: ${packet.pack}`;
        } else { // Courier
            packetText = `
Four Direction - 056-490449
Tracking Number: ${packet.trackingNumber}
${packet.update}
Date: ${packet.date}
Sender: ${packet.senderName} (${packet.senderContact})
Address: ${packet.senderAddress}
Weight: ${packet.weightTicket} KG
Receiver: ${packet.receiverName} (${packet.receiverContact})
Address: ${packet.receiverAddress}
Item: ${packet.courierTicket}`;
        }
        navigator.clipboard.writeText(packetText.trim()).then(() => showModal('Success', 'Print-friendly text copied!'));
    }
    window.copyForPrint = copyForPrint;

    function addTrackingInput() {
        const container = document.getElementById('trackingInputs');
        const div = document.createElement('div');
        div.className = 'dynamic-input-group';
        div.innerHTML = `
            <input type="text" class="dynamic-input">
            <button type="button" onclick="removeDynamicInput(this)" style="background-color: var(--accent-red-alt);">-</button>
        `;
        container.appendChild(div);
    }
    window.addTrackingInput = addTrackingInput;

    function removeDynamicInput(button) {
      button.parentElement.remove();
    }
    window.removeDynamicInput = removeDynamicInput;
    
    function getDynamicInputs(containerId) {
        const container = document.getElementById(containerId);
        const inputs = container.querySelectorAll('.dynamic-input');
        return Array.from(inputs).map(input => input.value).filter(val => val.trim());
    }

    function sendMail(key) {
      const packet = allPackets.find(p => p.key === key);
      if (!packet) return;
      if (!packet.email) {
        showModal("No Email Found", "No email address found for this entry.");
        return;
      }
      let subject = '';
      let mailBody = '';

      if (packet.entryType === 'ticketing') {
        subject = `Your Flight Itinerary from Four Direction - PNR: ${packet.pnrNumber}`;
        mailBody = `Dear ${packet.passengerName},\n\nWe hope this email finds you well.\n\nPlease find your flight itinerary below:\n\nPNR: ${packet.pnrNumber}\nTicket Number: ${packet.ticketNumber}\n\n${(packet.flightSegments || []).map(s => `Flight: ${s.airline} ${s.flightNo}\nDeparture: ${s.depAirport} at ${new Date(s.depDateTime).toLocaleString()}\nArrival: ${s.arrAirport} at ${new Date(s.arrDateTime).toLocaleString()}\n`).join('\n')}\nThank you for choosing our service.\n\nBest regards,\nFour Direction Travels & Tours\n056-490499 , 9855020449\nBhatpur-10, Hakim Chowk, Chitwan`;
      } else if (packet.entryType === 'manifest') {
        subject = `Your Manifest Details from Four Direction`;
        mailBody = `Dear Customer,\n\nHere are your manifest details:\n\nManifest No: ${packet.recNo}\nDate: ${packet.date}\nReceiver: ${packet.receiverName} in ${packet.receiverCountry}\n\nBest regards,\nFour Direction\n056-490499 , 9855020449\nBhatpur-10, Hakim Chowk, Chitwan`;
      } else { // Courier
        const trackingNumbers = (packet.trackingNumber || '').split(',').filter(t => t.trim());
        const trackingInfo = trackingNumbers.map(tn => {
          const tn_trim = tn.trim();
          const link = tn_trim.startsWith('SG')
            ? `https://shipglobal.au/tracking?waybill=${encodeURIComponent(tn_trim)}&submit=Track`
            : tn_trim.startsWith('FFC')
              ? `https://www.firstflightcanada.com/tracking?waybill=${encodeURIComponent(tn_trim)}&submit=Track`
              : `https://parcelsapp.com/en/tracking/${encodeURIComponent(tn_trim)}`;
          return `\nTracking Number: ${tn_trim}\nTracking Link: ${link}`;
        }).join('\n');
        subject = `Your Package Status from Four Direction`;
        mailBody = `Dear Customer,\n\nWe hope this email finds you well.\n\nWe are pleased to inform you that your recent shipment has been processed and assigned the following tracking information:${trackingInfo}\n\nIf you have any queries about your package please do not hesitate to contact us.\n\nBest regards,\nFour Direction Courier\n056-490499 , 9855020449\nBhatpur-10, Hakim Chowk, Chitwan`;
      }
      window.open(`https://mail.google.com/mail/u/0/?fs=1&tf=cm&to=${encodeURIComponent(packet.email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(mailBody)}`, '_blank');
    }
    window.sendMail = sendMail;

    function editPacket(key) {
        showModal('Confirm Edit', 'Are you sure you want to edit this entry?', 'confirm', () => {
            const packet = allPackets.find(p => p.key === key);
            if (!packet) return;
            
            const packetMode = packet.entryType || 'courier';
            setMode(packetMode);
            clearInputs(true);
            currentEditingPacket = packet; // Set after clearing to prevent it from being nulled
            
            document.getElementById('date').value = packet.date || '';
            document.getElementById('recNo').value = packet.recNo || '';
            document.getElementById('email').value = packet.email || '';
            document.getElementById('price').value = packet.price || '';

            if (packetMode === 'courier') {
                ['senderName', 'senderAddress', 'senderContact', 'weightTicket', 'receiverName', 'receiverAddress', 'receiverContact', 'update', 'billItem', 'deliveredDate', 'courierTicket'].forEach(key => {
                    document.getElementById(key).value = packet[key] || '';
                });
                populateDynamicInputs('trackingInputs', (packet.trackingNumber || '').split(','), addTrackingInput);
            } else if (packetMode === 'ticketing') {
                ['passengerName', 'passengerContact', 'pnrNumber', 'ticketNumber', 'tripType', 'luggageWeight', 'remarks'].forEach(key => {
                     document.getElementById(key).value = packet[key] || '';
                });
                if (packet.fareDetails) {
                    document.getElementById('baseFare').value = packet.fareDetails.base || '';
                    document.getElementById('taxes').value = packet.fareDetails.taxes || '';
                }
                if(packet.flightSegments) {
                    packet.flightSegments.forEach(segmentData => {
                        addFlightSegment(segmentData);
                    });
                }
            } else if (packetMode === 'manifest') {
                document.getElementById('pack').value = packet.pack || '';
                document.getElementById('manifestReceiverName').value = packet.receiverName || '';
                document.getElementById('receiverCountry').value = packet.receiverCountry || '';
                document.getElementById('manifestGateway').value = packet.update || '';
            }
            
            showEntrySection();
            window.scrollTo(0, 0);
        });
    }
    window.editPacket = editPacket;
    
    function populateDynamicInputs(containerId, values, addFunction) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const addBtnHTML = `<button type="button" onclick="${addFunction.name}()" style="width: 30px; background-color: var(--accent-green);">+</button>`;
        const initialGroupHTML = `<div class="dynamic-input-group"><input type="text" id="trackingNumber" class="dynamic-input">${addBtnHTML}</div>`;

        if (!values || values.length === 0 || values.every(v => !v.trim())) {
            container.innerHTML = initialGroupHTML;
            return;
        }

        values.forEach((value, index) => {
            const div = document.createElement('div');
            div.className = 'dynamic-input-group';
            const buttonHTML = index === 0 
                ? addBtnHTML
                : `<button type="button" onclick="removeDynamicInput(this)" style="background-color: var(--accent-red-alt);">-</button>`;
            div.innerHTML = `<input type="text" class="dynamic-input" value="${value.trim()}"> ${buttonHTML}`;
            container.appendChild(div);
        });
    }

    // --- NEW TICKETING & AI FUNCTIONS ---
    window.addFlightSegment = function(data = {}) {
        const container = document.getElementById('flightSegmentsContainer');
        const segmentCount = container.getElementsByClassName('flight-segment').length;
        const div = document.createElement('div');
        div.className = 'flight-segment';
        div.innerHTML = `
            <h4>Segment ${segmentCount + 1}</h4>
            <div class="segment-row">
                <input type="text" class="segment-airline" placeholder="Airline" value="${data.airline || ''}">
                <input type="text" class="segment-flightNo" placeholder="Flight No." value="${data.flightNo || ''}">
                <input type="text" class="segment-aircraft" placeholder="Aircraft" value="${data.aircraft || ''}">
            </div>
            <div class="segment-row">
                <input type="text" class="segment-depAirport" placeholder="Departure Airport" value="${data.depAirport || ''}">
                <input type="datetime-local" class="segment-depDateTime" title="Departure Date & Time" value="${data.depDateTime || ''}">
            </div>
            <div class="segment-row">
                <input type="text" class="segment-arrAirport" placeholder="Arrival Airport" value="${data.arrAirport || ''}">
                <input type="datetime-local" class="segment-arrDateTime" title="Arrival Date & Time" value="${data.arrDateTime || ''}">
            </div>
            <div class="segment-row">
                <input type="text" class="segment-terminal" placeholder="Terminal" value="${data.terminal || ''}">
                <button type="button" onclick="removeFlightSegment(this)" style="background-color: var(--accent-red-alt); width: 100px;">Remove</button>
            </div>
        `;
        container.appendChild(div);
    }
    
    window.removeFlightSegment = function(button) {
        const segmentDiv = button.closest('.flight-segment');
        segmentDiv.remove();
        const container = document.getElementById('flightSegmentsContainer');
        const segments = container.getElementsByClassName('flight-segment');
        Array.from(segments).forEach((segment, index) => {
            segment.querySelector('h4').textContent = `Segment ${index + 1}`;
        });
    }

    function getFlightSegments() {
        const segments = [];
        const segmentElements = document.getElementsByClassName('flight-segment');
        for (const segmentEl of segmentElements) {
            segments.push({
                airline: segmentEl.querySelector('.segment-airline').value,
                flightNo: segmentEl.querySelector('.segment-flightNo').value,
                aircraft: segmentEl.querySelector('.segment-aircraft').value,
                depAirport: segmentEl.querySelector('.segment-depAirport').value,
                depDateTime: segmentEl.querySelector('.segment-depDateTime').value,
                arrAirport: segmentEl.querySelector('.segment-arrAirport').value,
                arrDateTime: segmentEl.querySelector('.segment-arrDateTime').value,
                terminal: segmentEl.querySelector('.segment-terminal').value,
            });
        }
        return segments;
    }

    function formatDuration(minutes) {
        if (isNaN(minutes) || minutes < 0) return '';
        const d = Math.floor(minutes / (24 * 60));
        const h = Math.floor((minutes % (24 * 60)) / 60);
        const m = Math.round(minutes % 60);
        let result = '';
        if (d > 0) result += `${d}d `;
        if (h > 0) result += `${h}h `;
        if (m > 0 || (d === 0 && h === 0)) result += `${m}m`;
        return result.trim() || '0m';
    }

    function renderItinerary(packet) {
        if (!packet.flightSegments || packet.flightSegments.length === 0) return '';
        let itineraryHTML = '<div class="itinerary-display">';
        let totalFlightMinutes = 0, totalLayoverMinutes = 0;

        packet.flightSegments.forEach((segment, index) => {
            const depDate = new Date(segment.depDateTime);
            const arrDate = new Date(segment.arrDateTime);
            const flightMinutes = !isNaN(depDate) && !isNaN(arrDate) ? (arrDate - depDate) / 60000 : 0;
            totalFlightMinutes += flightMinutes > 0 ? flightMinutes : 0;
            
            itineraryHTML += `
                <div class="itinerary-segment">
                    âœˆï¸ <span>${highlightText(segment.depAirport)} â†’ ${highlightText(segment.arrAirport)}</span> (${highlightText(segment.airline)} ${highlightText(segment.flightNo)})
                    <br>&nbsp;&nbsp;&nbsp;&nbsp;Aircraft: ${highlightText(segment.aircraft)} | Duration: ${formatDuration(flightMinutes)}
                </div>
            `;

            if (index < packet.flightSegments.length - 1) {
                const nextDepDate = new Date(packet.flightSegments[index+1].depDateTime);
                const layoverMinutes = !isNaN(arrDate) && !isNaN(nextDepDate) ? (nextDepDate - arrDate) / 60000 : 0;
                totalLayoverMinutes += layoverMinutes > 0 ? layoverMinutes : 0;
                itineraryHTML += `<div class="itinerary-layover">ðŸ”„ Layover: ${formatDuration(layoverMinutes)}</div>`;
            }
        });
        
        const firstSegDate = new Date(packet.flightSegments[0].depDateTime);
        const lastSegDate = new Date(packet.flightSegments[packet.flightSegments.length - 1].arrDateTime);
        const totalJourneyMinutes = !isNaN(firstSegDate) && !isNaN(lastSegDate) ? (lastSegDate - firstSegDate) / 60000 : 0;

        itineraryHTML += `<div class="itinerary-summary">
            Total Journey: ${formatDuration(totalJourneyMinutes)} (Flight: ${formatDuration(totalFlightMinutes)}, Layover: ${formatDuration(totalLayoverMinutes)})
        </div></div>`;
        return itineraryHTML;
    }

    async function fileToGenerativePart(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const imagePart = {
            inlineData: {
              data: reader.result.split(',')[1],
              mimeType: file.type,
            },
          };
          lastAnalyzedImagePart = imagePart; // Store for follow-up
          resolve(imagePart);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    function getAiSchema() {
        const { GenaiType } = window;
        if (currentMode === 'ticketing') {
            return {
                type: GenaiType.OBJECT,
                properties: {
                    recNo: { type: GenaiType.STRING },
                    date: { type: GenaiType.STRING, description: "Format as YYYY-MM-DD" },
                    email: { type: GenaiType.STRING },
                    price: { type: GenaiType.NUMBER },
                    passengerName: { type: GenaiType.STRING },
                    passengerContact: { type: GenaiType.STRING },
                    pnrNumber: { type: GenaiType.STRING },
                    ticketNumber: { type: GenaiType.STRING },
                    tripType: { type: GenaiType.STRING, enum: ["ONE_WAY", "ROUND_TRIP"] },
                    baseFare: { type: GenaiType.NUMBER },
                    taxes: { type: GenaiType.NUMBER },
                    luggageWeight: { type: GenaiType.STRING },
                    remarks: { type: GenaiType.STRING },
                    flightSegments: {
                        type: GenaiType.ARRAY,
                        items: {
                            type: GenaiType.OBJECT,
                            properties: {
                                airline: { type: GenaiType.STRING },
                                flightNo: { type: GenaiType.STRING },
                                aircraft: { type: GenaiType.STRING },
                                depAirport: { type: GenaiType.STRING },
                                depDateTime: { type: GenaiType.STRING, description: "Format as YYYY-MM-DDTHH:mm" },
                                arrAirport: { type: GenaiType.STRING },
                                arrDateTime: { type: GenaiType.STRING, description: "Format as YYYY-MM-DDTHH:mm" },
                                terminal: { type: GenaiType.STRING },
                            }
                        }
                    },
                    ai_notes: { type: GenaiType.STRING, description: "Any notes or uncertainties about the extraction."}
                }
            };
        } else { // courier
            return {
                type: GenaiType.OBJECT,
                properties: {
                    recNo: { type: GenaiType.STRING },
                    date: { type: GenaiType.STRING, description: "Format as YYYY-MM-DD" },
                    email: { type: GenaiType.STRING },
                    price: { type: GenaiType.NUMBER },
                    senderName: { type: GenaiType.STRING },
                    senderAddress: { type: GenaiType.STRING },
                    senderContact: { type: GenaiType.STRING },
                    weightTicket: { type: GenaiType.STRING },
                    receiverName: { type: GenaiType.STRING },
                    receiverAddress: { type: GenaiType.STRING },
                    receiverContact: { type: GenaiType.STRING },
                    update: { type: GenaiType.STRING, description: "This is the 'Gateway' field." },
                    billItem: { type: GenaiType.STRING },
                    trackingNumber: { type: GenaiType.STRING, description: "Comma-separated if multiple"},
                    deliveredDate: { type: GenaiType.STRING, description: "Format as YYYY-MM-DD" },
                    courierTicket: { type: GenaiType.STRING, description: "This is the 'Item' description field." },
                    ai_notes: { type: GenaiType.STRING, description: "Any notes or uncertainties about the extraction."}
                }
            };
        }
    }
    
    async function runGeminiExtraction(parts, isFollowUp = false) {
        if (!window.geminiApiKey) {
            showAiMessage("AI features disabled. API key not configured.", "error");
            return;
        }
        const { GoogleGenAI } = window;
        const ai = new GoogleGenAI({ apiKey: window.geminiApiKey });

        const systemInstruction = "You are an intelligent data entry assistant for 'Four Direction Travels & Tours', a company handling courier and airline tickets. Extract information from the user's request into a JSON object based on the provided schema. Do not invent data. If a value is not present, use an empty string. If generating a new entry, suggest the next receipt number based on the last one provided.";
        
        const schema = getAiSchema();

        try {
            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: { parts: parts },
                config: {
                    systemInstruction: systemInstruction,
                    responseMimeType: "application/json",
                    responseSchema: schema,
                },
            });

            const data = JSON.parse(response.text);
            populateForm(data);
            const aiNote = data.ai_notes || (isFollowUp ? "Form updated based on your request." : "Data extracted successfully! Please review.");
            showAiMessage(aiNote, "ai");
        } catch (error) {
            console.error("AI Extraction Error:", error);
            const errorMessage = isFollowUp ? "Sorry, I couldn't understand that request. Please try rephrasing." : "Failed to extract data. The image might be unclear or the format is not recognized.";
            showAiMessage(errorMessage, "error");
        }
    }

    function getFormDataAsObject() {
        const data = {
            entryType: currentMode,
            recNo: document.getElementById('recNo').value,
            date: document.getElementById('date').value,
            email: document.getElementById('email').value,
            price: document.getElementById('price').value,
        };
        if (currentMode === 'courier') {
            Object.assign(data, {
                senderName: document.getElementById('senderName').value,
                senderAddress: document.getElementById('senderAddress').value,
                senderContact: document.getElementById('senderContact').value,
                weightTicket: document.getElementById('weightTicket').value,
                receiverName: document.getElementById('receiverName').value,
                receiverAddress: document.getElementById('receiverAddress').value,
                receiverContact: document.getElementById('receiverContact').value,
                update: document.getElementById('update').value,
                billItem: document.getElementById('billItem').value,
                trackingNumber: getDynamicInputs('trackingInputs').join(','),
                deliveredDate: document.getElementById('deliveredDate').value,
                courierTicket: document.getElementById('courierTicket').value
            });
        } else {
            Object.assign(data, {
                passengerName: document.getElementById('passengerName').value,
                passengerContact: document.getElementById('passengerContact').value,
                pnrNumber: document.getElementById('pnrNumber').value,
                ticketNumber: document.getElementById('ticketNumber').value,
                tripType: document.getElementById('tripType').value,
                baseFare: document.getElementById('baseFare').value,
                taxes: document.getElementById('taxes').value,
                flightSegments: getFlightSegments(),
                luggageWeight: document.getElementById('luggageWeight').value,
                remarks: document.getElementById('remarks').value
            });
        }
        return data;
    }

    async function sendAiFollowUp() {
        const userInput = document.getElementById('ai-user-input').value.trim();
        if (!userInput) return;
        
        showAiMessage(userInput, 'user');
        document.getElementById('ai-user-input').value = '';
        showAiMessage("Thinking...", "info");
        
        const currentData = getFormDataAsObject();
        const currentDataString = JSON.stringify(currentData, null, 2);
        
        const lastRecNo = allPackets.length > 0 ? Math.max(...allPackets.map(p => parseInt(p.recNo) || 0)) : 0;
        
        const prompt = `
            A user has uploaded a document (image attached if available) for data entry. The current state of the form is provided as a JSON object. The user now wants to make changes using a voice command.
            Your task is to analyze the user's command, the attached image, and the current data. Then, generate a complete, updated JSON object that incorporates the user's request. Adhere to the required schema.
            The last used receipt number was ${lastRecNo}.
            
            Current Data:
            ${currentDataString}

            User's Command (in Nepali or English):
            "${userInput}"

            Based on this command, review the image and the current data, and provide the final, corrected JSON object. Respond ONLY with the JSON object.
        `;
        
        const parts = [];
        if (lastAnalyzedImagePart) {
            parts.push(lastAnalyzedImagePart);
        }
        parts.push({ text: prompt });
        
        await runGeminiExtraction(parts, true);
    }

    function initializeSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            console.warn("Speech Recognition not supported in this browser.");
            document.getElementById('ai-record-btn').style.display = 'none';
            return;
        }
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'ne-NP'; // Primarily Nepali, but should handle English too.
        recognition.interimResults = true;
        recognition.maxAlternatives = 1;

        recognition.onresult = (event) => {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                transcript += event.results[i][0].transcript;
            }
            document.getElementById('ai-user-input').value = transcript;
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error', event.error);
            showAiMessage(`Speech error: ${event.error}`, "error");
        };

        recognition.onstart = () => {
            isRecording = true;
            const recordBtn = document.getElementById('ai-record-btn');
            recordBtn.classList.add('recording');
            recordBtn.textContent = 'â¹ï¸';
        };

        recognition.onend = () => {
            isRecording = false;
            const recordBtn = document.getElementById('ai-record-btn');
            recordBtn.classList.remove('recording');
            recordBtn.textContent = 'ðŸŽ¤';
        };
    }

    function toggleRecording() {
        if (!recognition) return;
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.start();
        }
    }

    function populateForm(data) {
        clearInputs(false); // Clear form before populating
        for (const key in data) {
            if (key === 'flightSegments') {
                (data.flightSegments || []).forEach(segment => addFlightSegment(segment));
            } else if (key === 'trackingNumber') {
                 populateDynamicInputs('trackingInputs', (data.trackingNumber || '').split(','), addTrackingInput);
            } else if (key === 'baseFare' || key === 'taxes') { // Handle baseFare/taxes outside fareDetails
                 document.getElementById(key).value = data[key] || '';
            } else {
                const element = document.getElementById(key);
                if (element) {
                    element.value = data[key];
                }
            }
        }
    }

    window.handleAutofill = async function() {
        const fileInput = document.getElementById('imageUpload');
        if (fileInput.files.length === 0) {
            showModal("No File Selected", "Please select an image or PDF file first.");
            return;
        }
        document.getElementById('ai-chat-history').innerHTML = ''; // Clear history
        showAiMessage("Analyzing file...", "info");
        
        const file = fileInput.files[0];
        try {
            const imagePart = await fileToGenerativePart(file);
            
            const lastRecNo = allPackets.length > 0 ? Math.max(...allPackets.map(p => parseInt(p.recNo) || 0)) : 0;
            const initialPrompt = currentMode === 'ticketing'
                ? `Extract flight ticket details. The last receipt number was ${lastRecNo}.`
                : `Extract courier receipt details. The last receipt number was ${lastRecNo}.`;

            await runGeminiExtraction([imagePart, { text: initialPrompt }], false);

        } catch (error) {
            console.error(error);
            showAiMessage("Could not process the file.", "error");
        }
    }

    function showAiMessage(message, type) { // type can be 'user', 'ai', 'info', 'error'
        const box = document.getElementById('ai-assistant-box');
        const history = document.getElementById('ai-chat-history');
        
        // remove any existing info message
        const existingInfo = history.querySelector('.info');
        if (existingInfo && type !== 'info') {
             existingInfo.remove();
        } else if (type === 'info' && existingInfo) {
             existingInfo.textContent = message;
             return;
        }

        const msgEl = document.createElement('div');
        msgEl.className = `chat-message ${type}`;
        msgEl.textContent = message;
        history.appendChild(msgEl);
        
        history.scrollTop = history.scrollHeight;
        box.classList.add('visible');
    }

    window.hideAiMessage = function() {
        document.getElementById('ai-assistant-box').classList.remove('visible');
    }

    function showEntrySection() {
      document.getElementById('entrySection').style.display = 'block';
    }
    window.showEntrySection = showEntrySection;
    function hideEntrySection() {
      document.getElementById('entrySection').style.display = 'none';
    }
    async function deletePacket(key) {
      showModal('Confirm Deletion', 'Are you sure you want to delete this entry? This action cannot be undone.', 'confirm', async () => {
          const packetToDelete = allPackets.find(p => p.key === key);
          if (!packetToDelete) return;
          
          logAction({ type: 'delete', deletedData: { ...packetToDelete } });

          await database.ref(packetToDelete.path).remove();
          
          if (currentEditingPacket && currentEditingPacket.key === key) {
              currentEditingPacket = null;
              clearInputs(true);
          }

          allPackets = allPackets.filter(p => p.key !== key);
          displayResults();
          showModal('Success', 'The entry has been deleted.');
      });
    }
    window.deletePacket = deletePacket;

    async function progressivelyLoadData() {
        const loadingStatus = document.getElementById('loadingStatus');
        const date = new Date();
        const dataRoots = ['packets', 'courier_packets', 'ticketing_packets', 'manifest_packets'];

        loadingStatus.textContent = 'Loading records...';
        
        let year = date.getFullYear();
        let month = date.getMonth() + 1;

        for (let i = 0; i < 61; i++) { // current month + 60 older months (5 years)
            for (const root of dataRoots) {
                await fetchDataForMonth(root, year, String(month).padStart(2, '0'));
            }
            month--;
            if (month === 0) {
                month = 12;
                year--;
            }
        }

        loadingStatus.textContent = 'All records loaded.';
        setTimeout(() => { loadingStatus.style.display = 'none'; }, 3000);
    }

    async function fetchDataForMonth(root, year, month) {
        const dataPath = `${root}/${year}/${month}`;
        try {
            const snapshot = await database.ref(dataPath).once('value');
            if (snapshot.exists()) {
                const monthPackets = [];
                snapshot.forEach((childSnapshot) => {
                    const key = childSnapshot.key;
                    if (!processedKeys.has(key)) {
                        monthPackets.push({
                            ...childSnapshot.val(),
                            key: key,
                            path: `${dataPath}/${key}`
                        });
                        processedKeys.add(key);
                    }
                });
                if (monthPackets.length > 0) {
                    allPackets.push(...monthPackets);
                    displayResults();
                }
            }
        } catch (error) {
            console.error(`Failed to fetch data from ${dataPath}:`, error);
        }
    }


    function clearInputs(clearAll = true) {
        const selectors = ['#courierForm input, #courierForm textarea', '#ticketingForm input, #ticketingForm textarea, #ticketingForm select', '#manifestForm input, #manifestForm textarea'];
        if (clearAll) {
            selectors.push('#entrySection > div > input[type="date"], #entrySection > div > input[type="number"], #entrySection > div > input[type="text"]');
        }
        document.querySelectorAll(selectors.join(', ')).forEach(input => {
             if(input.id !== 'adminEmail') input.value = '';
        });
        document.getElementById('trackingInputs').innerHTML = `<div class="dynamic-input-group"><input type="text" id="trackingNumber" class="dynamic-input"><button type="button" onclick="addTrackingInput()" style="width: 30px; background-color: var(--accent-green);">+</button></div>`;
        document.getElementById('flightSegmentsContainer').innerHTML = '';
        addFlightSegment(); // Add one blank segment back
        if(clearAll) {
          currentEditingPacket = null; // Clear editing state only when doing a full clear
        }
    }

    function calculateAndDisplayTotal(displayedPackets) {
      const total = displayedPackets.reduce((acc, packet) => acc + (parseFloat(packet.price) || 0), 0);
      const label = currentMode === 'manifest' ? `Price for ${currentMode}` : `Total Price for ${currentMode}`;
      document.getElementById('totalPrice').textContent = `${label}: RS.${total.toFixed(2)}`;
    }

    function calculateAndDisplayTotalPackages(displayedPackets) {
      const totalPackagesEl = document.getElementById('totalPackages');
      if (currentMode === 'manifest') {
        const total = displayedPackets.reduce((acc, packet) => acc + (parseFloat(packet.pack) || 0), 0);
        totalPackagesEl.textContent = `Packages: ${total}`;
      } else {
        totalPackagesEl.textContent = '';
      }
    }

    async function initializeApp() {
      const savedMode = localStorage.getItem('entryMode') || 'courier';
      setMode(savedMode);
      addFlightSegment();
      
      initializeSpeechRecognition();

      document.getElementById('dateLimit').addEventListener('change', searchData);
      document.getElementById('ai-record-btn').addEventListener('click', toggleRecording);
      document.getElementById('ai-send-btn').addEventListener('click', sendAiFollowUp);
      document.getElementById('ai-user-input').addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendAiFollowUp();
          }
      });
      
      updateUndoButtonState();

      console.log("Admin verified. Loading application.");
      
      database.ref('config/geminiApiKey').once('value', (snapshot) => {
        if (snapshot.exists()) {
          window.geminiApiKey = snapshot.val();
          console.log("Gemini API Key loaded.");
        } else {
          console.warn("Gemini API Key not found in Firebase config.");
          showAiMessage("AI features disabled. API key not configured.", "error");
        }
      });
      progressivelyLoadData();
    }

    const auth = firebase.auth();
    const loginOverlay = document.getElementById('loginOverlay');
    const loginButton = document.getElementById('loginButton');
    const adminPasswordInput = document.getElementById('adminPassword');
    const loginError = document.getElementById('loginError');
    const ADMIN_UID = "CF4g7aQ7WFPK6kOEMHxxbMXD9mp2";

    function performLogin() {
      const password = adminPasswordInput.value;
      const email = "fourdirection02@gmail.com";
      if (!password) {
        loginError.textContent = 'Password is required.';
        return;
      }
      auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
        .then(() => auth.signInWithEmailAndPassword(email, password))
        .catch(error => {
          loginError.textContent = 'Login failed: Incorrect password.';
        });
    }

    loginButton.addEventListener('click', performLogin);
    adminPasswordInput.addEventListener('keyup', (event) => {
      if (event.key === "Enter") performLogin();
    });

    auth.onAuthStateChanged(user => {
      if (user && user.uid === ADMIN_UID) {
        loginOverlay.classList.remove('visible');
        initializeApp();
      } else {
        if (user) auth.signOut();
        loginOverlay.classList.add('visible');
        adminPasswordInput.focus();
      }
    });

    const themeToggle = document.getElementById('theme-toggle');
    const setTheme = (theme) => {
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.textContent = 'â˜€ï¸';
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark-mode');
        themeToggle.textContent = 'ðŸŒ™';
        localStorage.setItem('theme', 'light');
      }
    }
    setTheme(localStorage.getItem('theme') || 'light');
    themeToggle.addEventListener('click', () => {
      setTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark');
    });

  </script>
</body>

</html>
